<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Matching - CoursePilot Kenya</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2c5aa0;
            --secondary: #e74c3c;
            --accent: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --success: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Header & Navigation */
        .header {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
        }

        .logo i {
            color: var(--secondary);
        }

        /* Desktop Navigation */
        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
            align-items: center;
        }

        .nav-links a {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--secondary);
        }

        .nav-cta {
            background: var(--secondary);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            text-decoration: none;
        }

        /* Mobile Navigation */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--dark);
            cursor: pointer;
        }

        .mobile-nav {
            display: none;
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            z-index: 999;
        }

        .mobile-nav.active {
            display: block;
        }

        .mobile-nav-links {
            list-style: none;
            padding: 1rem 0;
        }

        .mobile-nav-links li {
            border-bottom: 1px solid #eee;
        }

        .mobile-nav-links a {
            display: block;
            padding: 1rem 2rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: background 0.3s;
        }

        .mobile-nav-links a:hover {
            background: var(--light);
        }

        /* Page Content */
        .page-content {
            padding: 120px 2rem 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--dark);
        }

        .form-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .subject-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
        }

        .terms-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
        }

        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .terms-checkbox input {
            width: auto;
            margin-top: 5px;
        }

        .terms-text {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .service-button {
            background: var(--primary);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }

        .service-button:hover {
            background: #1a3a7a;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .results-section {
            display: none;
            margin-top: 2rem;
            padding: 2rem;
            background: var(--light);
            border-radius: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }

        .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn {
            background: var(--success);
            color: white;
        }

        .new-search-btn {
            background: var(--secondary);
            color: white;
        }

        .programme-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .programme-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .programme-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1em;
            margin-bottom: 0.5rem;
        }

        .programme-university {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .programme-points {
            color: var(--secondary);
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
            }

            .page-content {
                padding: 100px 1rem 1rem;
            }

            .form-container {
                padding: 1.5rem;
            }

            .form-header h1 {
                font-size: 2rem;
            }

            .subjects-grid {
                grid-template-columns: 1fr;
            }

            .nav-container {
                padding: 1rem;
            }

            .logo {
                font-size: 1.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <i class="fas fa-graduation-cap"></i>
                CoursePilot Kenya
            </a>
            
            <!-- Desktop Navigation -->
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="calculator.html">Calculator</a></li>
                <li><a href="courses.html">Courses</a></li>
                <li><a href="premium.html">Premium</a></li>
                <li><a href="articles.html">Career Guide</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="#" class="nav-cta" onclick="showAdminModal()">Admin</a></li>
            </ul>

            <!-- Mobile Menu Button -->
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- Mobile Navigation -->
        <div class="mobile-nav" id="mobileNav">
            <ul class="mobile-nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="calculator.html">Calculator</a></li>
                <li><a href="courses.html">Courses</a></li>
                <li><a href="premium.html">Premium</a></li>
                <li><a href="articles.html">Career Guide</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="#" onclick="showAdminModal()">Admin</a></li>
            </ul>
        </div>
    </header>

    <!-- Course Matching Content -->
    <div class="page-content">
        <div class="form-container">
            <div class="form-header">
                <h1><i class="fas fa-search"></i> Course Matching Service</h1>
                <p>Find all degree programs you qualify for - KSh 100</p>
            </div>

            <div class="error" id="courseError"></div>
            
            <div class="form-group">
                <label for="clusterPoints">Your Cluster Points:</label>
                <input type="number" id="clusterPoints" placeholder="Enter your cluster points e.g., 42.5" step="0.1" min="0" max="48">
            </div>

            <div class="form-group">
                <label>Your Subject Grades:</label>
                <div class="subjects-grid" id="subjectsContainer"></div>
            </div>

            <div class="terms-section">
                <div class="terms-checkbox">
                    <input type="checkbox" id="agreeTerms">
                    <div class="terms-text">
                        I understand that results are based on 2024 KUCCPS data and should be verified with the official KUCCPS portal. 
                        CoursePilot provides guidance only and is not responsible for placement outcomes. The service provider makes no 
                        warranties about the accuracy of course eligibility information. Always double-check with official university requirements.
                    </div>
                </div>
            </div>

            <button class="service-button" onclick="processPayment()">
                <i class="fas fa-lock"></i> Find My Courses - KSh 100
            </button>

            <div class="results-section" id="resultsSection">
                <h3>Your Eligible Courses</h3>
                <div class="action-buttons">
                    <button class="action-button download-btn" onclick="downloadPDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <button class="action-button new-search-btn" onclick="newSearch()">
                        <i class="fas fa-redo"></i> New Search
                    </button>
                </div>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <script>
        const subjects = [
    "Mathematics", "English", "Kiswahili", "Physics", "Chemistry", 
    "Biology", "Geography", "History", "Business Studies", "Agriculture",
    "Computer Studies", "French", "German", "Arabic", "Music", "Art & Design"
];

const grades = ["A", "A-", "B+", "B", "B-", "C+", "C", "C-", "D+", "D", "D-", "E"];

function initializeSubjects() {
    const container = document.getElementById('subjectsContainer');
    container.innerHTML = '';
    
    subjects.forEach(subject => {
        const subjectItem = document.createElement('div');
        subjectItem.className = 'subject-item';
        
        subjectItem.innerHTML = `
            <span>${subject}</span>
            <select id="grade-${subject}">
                <option value="">Select Grade</option>
                ${grades.map(grade => `<option value="${grade}">${grade}</option>`).join('')}
            </select>
        `;
        
        container.appendChild(subjectItem);
    });
}

async function processPayment() {
    const clusterPoints = document.getElementById('clusterPoints').value;
    
    if (!clusterPoints) {
        showError('Please enter your cluster points first');
        return;
    }

    if (!document.getElementById('agreeTerms').checked) {
        showError('Please agree to the terms and conditions');
        return;
    }

    // Collect grades to verify user has entered data
    const userGrades = {};
    subjects.forEach(subject => {
        const grade = document.getElementById(`grade-${subject}`).value;
        if (grade) {
            userGrades[subject] = grade;
        }
    });

    if (Object.keys(userGrades).length === 0) {
        showError('Please enter at least one subject grade');
        return;
    }

    const phone = prompt('Enter your M-Pesa phone number (e.g., 254712345678):');
    if (!phone) return;
    
    try {
        showError('Initiating payment... Please wait.');
        
        const response = await fetch('https://novabloodemperor-tech-backend.onrender.com/api/pay/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone: phone,
                amount: 1, // KSh 1 for testing (change to 100 later)
                account_ref: 'course_search',
                desc: 'Course Matching Service'
            })
        });
        
        const data = await response.json();
        console.log('Payment response:', data);
        
        if (response.ok) {
            if (data.error) {
                showError('Payment failed: ' + data.error);
            } else {
                alert('‚úÖ Payment initiated! Check your phone to complete M-Pesa transaction.');
                // After successful payment, show courses
                setTimeout(() => {
                    findCourses();
                }, 2000);
            }
        } else {
            showError('Payment failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Payment error:', error);
        showError('Payment error: ' + error.message);
    }
}

async function findCourses() {
    const clusterPoints = document.getElementById('clusterPoints').value;
    
    if (!clusterPoints) {
        showError('Please enter your cluster points');
        return;
    }

    if (!document.getElementById('agreeTerms').checked) {
        showError('Please agree to the terms and conditions');
        return;
    }

    // Collect grades
    const userGrades = {};
    subjects.forEach(subject => {
        const grade = document.getElementById(`grade-${subject}`).value;
        if (grade) {
            userGrades[subject] = grade;
        }
    });

    if (Object.keys(userGrades).length === 0) {
        showError('Please enter at least one subject grade');
        return;
    }

    try {
        console.log('Making POST request to check-eligibility');
        console.log('Request data:', {
            cluster_points: parseFloat(clusterPoints),
            grades: userGrades
        });

        const response = await fetch('https://novabloodemperor-tech-backend.onrender.com/api/check-eligibility/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cluster_points: parseFloat(clusterPoints),
                grades: userGrades
            })
        });
        
        console.log('Response status:', response.status);
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (response.ok) {
            showResults(data, clusterPoints);
        } else {
            showError('Error checking eligibility: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Full error:', error);
        showError('Network error: ' + error.message);
    }
}

function showResults(data, userPoints) {
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');
    
    if (data.eligible_programmes.length === 0) {
        resultsContent.innerHTML = '<p>No courses found matching your criteria. Try adjusting your grades or cluster points.</p>';
    } else {
        let content = `<p><strong>Found ${data.total_found} eligible courses:</strong></p>`;
        data.eligible_programmes.forEach(programme => {
            content += `
                <div class="programme-card">
                    <div class="programme-name">${programme.programme_name}</div>
                    <div class="programme-university">üèõÔ∏è ${programme.university}</div>
                    <div class="programme-points">üìä Required: ${programme.required_cluster} points | Your points: ${userPoints}</div>
                    <div class="programme-code">üî¢ Code: ${programme.programme_code}</div>
                </div>
            `;
        });
        resultsContent.innerHTML = content;
    }
    
    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}

function showError(message) {
    const errorElement = document.getElementById('courseError');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    setTimeout(() => {
        errorElement.style.display = 'none';
    }, 5000);
}

async function downloadPDF() {
    try {
        const resultsContent = document.getElementById('resultsContent');
        if (!resultsContent.innerHTML.includes('programme-card')) {
            alert('No course results to download');
            return;
        }

        // Get the current course data
        const clusterPoints = document.getElementById('clusterPoints').value;
        const userGrades = {};
        subjects.forEach(subject => {
            const grade = document.getElementById(`grade-${subject}`).value;
            if (grade) {
                userGrades[subject] = grade;
            }
        });

        // Get eligible programmes from the displayed results
        const eligibleProgrammes = [];
        document.querySelectorAll('.programme-card').forEach(card => {
            const programmeName = card.querySelector('.programme-name').textContent;
            const university = card.querySelector('.programme-university').textContent.replace('üèõÔ∏è ', '');
            const pointsText = card.querySelector('.programme-points').textContent;
            const requiredPoints = pointsText.match(/Required: (\d+(\.\d+)?) points/)[1];
            const programmeCode = card.querySelector('.programme-code').textContent.replace('üî¢ Code: ', '');
            
            eligibleProgrammes.push({
                programme_name: programmeName,
                university: university,
                required_cluster: parseFloat(requiredPoints),
                programme_code: programmeCode
            });
        });

        // Show loading
        const downloadBtn = document.querySelector('.download-btn');
        const originalText = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
        downloadBtn.disabled = true;

        // Call PDF download endpoint
        const response = await fetch('https://novabloodemperor-tech-backend.onrender.com/api/download-pdf/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                eligible_programmes: eligibleProgrammes,
                user_points: clusterPoints,
                user_grades: userGrades
            })
        });

        if (response.ok) {
            // Create download link
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'coursepilot_courses.pdf';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            alert('PDF downloaded successfully!');
        } else {
            const errorData = await response.json();
            alert('PDF download failed: ' + (errorData.error || 'Unknown error'));
        }

    } catch (error) {
        console.error('PDF download error:', error);
        alert('PDF download error: ' + error.message);
    } finally {
        // Restore button
        const downloadBtn = document.querySelector('.download-btn');
        if (downloadBtn) {
            downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download PDF';
            downloadBtn.disabled = false;
        }
    }
}


function newSearch() {
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('clusterPoints').value = '';
    document.getElementById('agreeTerms').checked = false;
    subjects.forEach(subject => {
        document.getElementById(`grade-${subject}`).value = '';
    });
}

// Mobile Menu Functions
function toggleMobileMenu() {
    const mobileNav = document.getElementById('mobileNav');
    mobileNav.classList.toggle('active');
}

// Close mobile menu when clicking outside
document.addEventListener('click', function(event) {
    const mobileNav = document.getElementById('mobileNav');
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    
    if (!mobileNav.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
        mobileNav.classList.remove('active');
    }
});

// Close mobile menu when clicking a link
document.querySelectorAll('.mobile-nav-links a').forEach(link => {
    link.addEventListener('click', () => {
        document.getElementById('mobileNav').classList.remove('active');
    });
});

function showAdminModal() {
    const password = prompt('Enter admin password:');
    if (password === 'admin123') {
        window.open('http://127.0.0.1:8000/admin', '_blank');
    } else if (password) {
        alert('Incorrect password');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', initializeSubjects);
    </script>
</body>
</html>